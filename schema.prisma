// Prisma schema for PostgreSQL (Neon Database)
// Production-ready configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  users       User[]
  messages    Message[]
  tasks       Task[]
  activityLogs ActivityLog[]
  requisitions Requisition[]
  needs       Need[]
  meetings    Meeting[]
  emailAccounts EmailAccount[]
  emailSelections EmailActiveSelection[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
}

model User {
  id              Int           @id @default(autoincrement())
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  Int
  externalId      String?       @unique
  email           String?       @unique
  displayName     String?
  name            String?       // Nom d'affichage pour l'auth PIN
  pinHash         String?       // Hash du PIN pour connexion
  role            String        // 'admin' | 'user' | 'viewer'
  messages        Message[]
  tasks           Task[]
  activityLogs    ActivityLog[]
  requisitionsRequested Requisition[] @relation("UserRequestedRequisitions")
  workflowStepsReviewed  WorkflowStep[] @relation("UserReviewedSteps")
  needsRequested Need[] @relation("UserRequestedNeeds")
  needWorkflowStepsReviewed NeedWorkflowStep[] @relation("UserReviewedNeedSteps")
  meetingsCreated Meeting[]
  emailAccounts   EmailAccount[]
  emailSelections EmailActiveSelection[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([organizationId, role])
  @@index([organizationId, name])
}

model Message {
  id             BigInt        @id @default(autoincrement())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         Int?
  kind           String        @default("system") // 'system' | 'user' | 'app'
  channel        String?       @default("app")
  content        String
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([kind])
  @@index([channel])
}

model Task {
  id             BigInt        @id @default(autoincrement())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         Int?
  title          String
  description    String?
  status         String        @default("pending") // 'pending' | 'in_progress' | 'done' | 'cancelled'
  dueAt          DateTime?
  metadata       Json?
  runs           TaskRun[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId, status])
  @@index([userId, status])
  @@index([dueAt])
}

model TaskRun {
  id        BigInt   @id @default(autoincrement())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    BigInt
  runType   String   @default("manual") // 'manual' | 'auto' | 'retry'
  result    String   @default("ok")     // 'ok' | 'error' | 'skipped'
  message   String?
  createdAt DateTime @default(now())

  @@index([taskId, createdAt(sort: Desc)])
}

model ActivityLog {
  id             BigInt        @id @default(autoincrement())
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId         Int?
  subjectType    String
  subjectId      BigInt?
  action         String
  detail         String?
  createdAt      DateTime      @default(now())

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
}

model Requisition {
  id            String      @id @default(uuid())
  title         String
  description   String
  category      String
  priority      String
  budget        Float
  justification String
  status        String      @default("soumis")
  requester     User?       @relation(name: "UserRequestedRequisitions", fields: [requesterId], references: [id], onDelete: SetNull)
  requesterId   Int?
  organization  Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int
  workflow      WorkflowStep[]
  approvedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([organizationId, status])
  @@index([requesterId])
}

model WorkflowStep {
  id             String      @id @default(uuid())
  requisition    Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  requisitionId  String
  reviewer       User?       @relation(name: "UserReviewedSteps", fields: [reviewerId], references: [id], onDelete: SetNull)
  reviewerId     Int?
  reviewerName   String
  reviewerLevel  Int
  action         String      @default("pending")
  isRequired     Boolean     @default(true)
  isCompleted    Boolean     @default(false)
  comment        String?
  createdAt      DateTime    @default(now())
  completedAt    DateTime?
}

model Meeting {
  id               String        @id @default(cuid())
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId   Int
  creator          User?         @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  creatorId        Int?
  title            String
  notes            String        @default("")
  participants     Json?
  status           String        @default("draft")
  extractedActions Json?
  tasksCreated     Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([organizationId, updatedAt(sort: Desc)])
  @@index([status])
}

// Email accounts per organization/user, with a per-user active selection
model EmailAccount {
  id               String        @id @default(cuid())
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId   Int
  owner            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId           Int?
  email            String
  providerId       String        // e.g., 'gmail' | 'outlook' | 'imap'
  providerName     String?
  provider         Json?         // full provider object as used by UI
  credentials      Json?         // oauth or imap creds (safely stored server-side)
  isConnected      Boolean       @default(true)
  unreadCount      Int           @default(0)
  connectedAt      DateTime?
  lastSync         DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  selections       EmailActiveSelection[]

  @@index([organizationId, email])
  @@index([organizationId, providerId])
  @@index([userId])
}

model EmailActiveSelection {
  id               Int           @id @default(autoincrement())
  organization     Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId   Int
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           Int
  account          EmailAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId        String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([organizationId, userId])
}

// Système de besoins (Needs)
model Need {
  id             String        @id @default(uuid())
  title          String
  description    String
  category       String        // 'materiel' | 'logiciel' | 'formation' | 'service' | 'fourniture' | 'maintenance' | 'autre'
  priority       String        // 'faible' | 'moyenne' | 'haute' | 'urgente'
  budget         Float         @default(0)
  justification  String?
  status         String        @default("soumis") // 'brouillon' | 'soumis' | 'en_review' | 'approuve' | 'rejete' | 'complete' | 'annule'
  requester      User?         @relation(name: "UserRequestedNeeds", fields: [requesterId], references: [id], onDelete: SetNull)
  requesterId    Int?
  requesterName  String?
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId Int
  workflow       NeedWorkflowStep[]
  attachments    NeedAttachment[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId, status])
  @@index([requesterId])
}

model NeedWorkflowStep {
  id             String    @id @default(uuid())
  need           Need      @relation(fields: [needId], references: [id], onDelete: Cascade)
  needId         String
  reviewer       User?     @relation(name: "UserReviewedNeedSteps", fields: [reviewerId], references: [id], onDelete: SetNull)
  reviewerId     Int?
  reviewerName   String
  reviewerLevel  Int
  action         String    @default("pending") // 'pending' | 'approved' | 'rejected' | 'commented' | 'requested_info'
  isRequired     Boolean   @default(true)
  isCompleted    Boolean   @default(false)
  comment        String?
  createdAt      DateTime  @default(now())
  completedAt    DateTime?
}

model NeedAttachment {
  id          String    @id @default(uuid())
  need        Need      @relation(fields: [needId], references: [id], onDelete: Cascade)
  needId      String
  fileName    String
  fileSize    Int
  fileType    String
  uploadedBy  String
  url         String
  createdAt   DateTime  @default(now())

  @@index([needId])
}

// ============================================
// MODÈLES FACTURATION (ICONES & ALL IN ONE)
// ============================================

model InvoiceClient {
  id              String    @id @default(uuid())
  company         String    // 'icones' | 'allinone'
  companyName     String    // Nom de l'entreprise cliente
  contactName     String    // Nom du contact
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String?
  taxNumber       String?   // Numéro de taxe/TVA
  notes           String?
  invoices        Invoice[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([company])
  @@index([companyName])
}

model Invoice {
  id                  String    @id @default(uuid())
  invoiceNumber       String    @unique  // Ex: FAC-2025-0001 ou N°012/C.E/Juil/25
  template            String    // facture_a, facture_b, placement, transfert, etc.
  company             String    // 'icones' | 'allinone'
  
  // Relations
  client              InvoiceClient @relation(fields: [clientId], references: [id])
  clientId            String
  
  // Snapshot client au moment de la facture
  clientSnapshot      Json?     // Copie des données client
  
  // Dates
  issueDate           DateTime
  dueDate             DateTime
  
  // Lignes de facture
  lines               InvoiceLine[]
  sections            InvoiceSection[]
  
  // Montants
  subtotal            Float     @default(0)
  taxRate             Float     @default(0)
  taxAmount           Float     @default(0)
  total               Float     @default(0)
  
  // Champs spécifiques ALL IN ONE
  serviceType         String?   // Type de service
  templateCode        String?   // Code template (C.E, Plac, etc.)
  
  // Options Placement
  placementTVAEnabled Boolean   @default(false)
  chargesTTCMode      Boolean   @default(true)
  placementDeduction  Float     @default(0)
  enablePlacementDeduction Boolean @default(false)
  
  // Options Transfert
  transfertDeduction  Float     @default(0)
  enableTransfertDeduction Boolean @default(false)
  
  // Options Facture B
  projectDescription  String?
  projectName         String?
  managementFeeRate   Float?
  commissionRate      Float?
  acomptes            Json?     // {acompte1: {percent, amount}, acompte2: {amount}, acompte3: {amount}, totalPaye}
  
  // Statut & Paiement
  status              String    @default("draft") // draft, sent, partial, paid, overdue, cancelled
  paymentTerms        String?
  paymentMethod       String?
  paidAt              DateTime?
  paidAmount          Float     @default(0)
  
  // Paiements
  payments            InvoicePayment[]
  
  // Notes
  notes               String?
  publicNotes         String?
  
  // Métadonnées
  createdBy           String
  createdByInitials   String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([company])
  @@index([status])
  @@index([clientId])
  @@index([issueDate])
  @@index([invoiceNumber])
}

model InvoiceLine {
  id              String    @id @default(uuid())
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String
  
  description     String
  quantity        Float     @default(1)
  unitPrice       Float     @default(0)
  total           Float     @default(0)
  
  // Pour Placement/Transfert
  chargesTTC      Float?    // Charges TTC
  
  // Pour Facture B
  squareMeters    Float?    // M²
  days            Float?    // Jours
  
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())

  @@index([invoiceId])
}

model InvoiceSection {
  id              String    @id @default(uuid())
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String
  
  title           String
  subtotal        Float     @default(0)
  sortOrder       Int       @default(0)
  
  lines           InvoiceSectionLine[]
  createdAt       DateTime  @default(now())

  @@index([invoiceId])
}

model InvoiceSectionLine {
  id              String    @id @default(uuid())
  section         InvoiceSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  sectionId       String
  
  description     String
  quantity        Float     @default(1)
  squareMeters    Float?
  days            Float?
  unitPrice       Float     @default(0)
  total           Float     @default(0)
  daysImpactPrice Boolean   @default(true)
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())

  @@index([sectionId])
}

model InvoicePayment {
  id              String    @id @default(uuid())
  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceId       String
  
  amount          Float
  paymentDate     DateTime
  paymentMethod   String?
  reference       String?
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([invoiceId])
}

// ============================================
// TRÉSORERIE & DÉPENSES
// ============================================

model ExpenseCategory {
  id              String    @id @default(uuid())
  company         String    // 'icones' | 'allinone'
  name            String    // Ex: "Loyer", "Salaires", "Fournitures"
  color           String?   // Couleur pour l'affichage
  icon            String?   // Icône (ex: "home", "users", "box")
  isActive        Boolean   @default(true)
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  expenses        Expense[]
  
  @@unique([company, name])
  @@index([company])
}

model Expense {
  id              String    @id @default(uuid())
  company         String    // 'icones' | 'allinone'
  
  // Catégorie
  category        ExpenseCategory? @relation(fields: [categoryId], references: [id])
  categoryId      String?
  
  // Détails
  description     String
  amount          Float
  expenseDate     DateTime
  
  // Paiement
  paymentMethod   String?   // "Espèces", "Virement", "Chèque", "Carte"
  reference       String?   // N° de chèque, référence virement, etc.
  vendor          String?   // Fournisseur/Bénéficiaire
  
  // Pièce jointe (reçu, facture)
  receiptUrl      String?
  
  // Notes
  notes           String?
  
  // Métadonnées
  createdBy       String?
  createdByName   String?
  isRecurring     Boolean   @default(false)
  recurringType   String?   // "monthly", "weekly", "yearly"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([company])
  @@index([categoryId])
  @@index([expenseDate])
}

// Vue mensuelle de la trésorerie (cache pour performance)
model TreasuryMonth {
  id              String    @id @default(uuid())
  company         String    // 'icones' | 'allinone'
  year            Int
  month           Int       // 1-12
  
  // Totaux calculés
  totalIncome     Float     @default(0) // Total des factures encaissées
  totalExpenses   Float     @default(0) // Total des dépenses
  balance         Float     @default(0) // Income - Expenses
  
  // Détails par catégorie (JSON)
  expensesByCategory Json?
  
  // Métadonnées
  lastUpdated     DateTime  @default(now())
  
  @@unique([company, year, month])
  @@index([company])
}
